#pragma checksum "G:\ATuanLM\AuditProject\Audit\Program\Core\WebAppCoreBlazorNew\Pages\Search.razor" "{ff1816ec-aa5e-4d10-87f7-6f4963833460}" "e2b6ef24e3012227d01591be33e4a200d365b070"
// <auto-generated/>
#pragma warning disable 1591
#pragma warning disable 0414
#pragma warning disable 0649
#pragma warning disable 0169

namespace WebAppCoreBlazorNew.Pages
{
    #line hidden
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using Microsoft.AspNetCore.Components;
#nullable restore
#line 1 "G:\ATuanLM\AuditProject\Audit\Program\Core\WebAppCoreBlazorNew\_Imports.razor"
using System.Net.Http;

#line default
#line hidden
#nullable disable
#nullable restore
#line 2 "G:\ATuanLM\AuditProject\Audit\Program\Core\WebAppCoreBlazorNew\_Imports.razor"
using System.Net.Http.Json;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "G:\ATuanLM\AuditProject\Audit\Program\Core\WebAppCoreBlazorNew\_Imports.razor"
using Microsoft.AspNetCore.Components.Forms;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "G:\ATuanLM\AuditProject\Audit\Program\Core\WebAppCoreBlazorNew\_Imports.razor"
using Microsoft.AspNetCore.Components.Routing;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "G:\ATuanLM\AuditProject\Audit\Program\Core\WebAppCoreBlazorNew\_Imports.razor"
using Microsoft.AspNetCore.Components.Web;

#line default
#line hidden
#nullable disable
#nullable restore
#line 6 "G:\ATuanLM\AuditProject\Audit\Program\Core\WebAppCoreBlazorNew\_Imports.razor"
using Microsoft.JSInterop;

#line default
#line hidden
#nullable disable
#nullable restore
#line 7 "G:\ATuanLM\AuditProject\Audit\Program\Core\WebAppCoreBlazorNew\_Imports.razor"
using WebAppCoreBlazorNew;

#line default
#line hidden
#nullable disable
#nullable restore
#line 8 "G:\ATuanLM\AuditProject\Audit\Program\Core\WebAppCoreBlazorNew\_Imports.razor"
using WebAppCoreBlazorNew.Shared;

#line default
#line hidden
#nullable disable
#nullable restore
#line 2 "G:\ATuanLM\AuditProject\Audit\Program\Core\WebAppCoreBlazorNew\Pages\Search.razor"
using Newtonsoft.Json;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "G:\ATuanLM\AuditProject\Audit\Program\Core\WebAppCoreBlazorNew\Pages\Search.razor"
using WebModel;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "G:\ATuanLM\AuditProject\Audit\Program\Core\WebAppCoreBlazorNew\Pages\Search.razor"
using System.Web.Mvc;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "G:\ATuanLM\AuditProject\Audit\Program\Core\WebAppCoreBlazorNew\Pages\Search.razor"
using WebModel.CodeInfo;

#line default
#line hidden
#nullable disable
#nullable restore
#line 6 "G:\ATuanLM\AuditProject\Audit\Program\Core\WebAppCoreBlazorNew\Pages\Search.razor"
using WebModel.Common;

#line default
#line hidden
#nullable disable
#nullable restore
#line 7 "G:\ATuanLM\AuditProject\Audit\Program\Core\WebAppCoreBlazorNew\Pages\Search.razor"
using WebAppCoreBlazorNew.Common;

#line default
#line hidden
#nullable disable
#nullable restore
#line 8 "G:\ATuanLM\AuditProject\Audit\Program\Core\WebAppCoreBlazorNew\Pages\Search.razor"
using WebAppCoreBlazorWebAssembly.Service;

#line default
#line hidden
#nullable disable
#nullable restore
#line 9 "G:\ATuanLM\AuditProject\Audit\Program\Core\WebAppCoreBlazorNew\Pages\Search.razor"
using Microsoft.Extensions.Configuration;

#line default
#line hidden
#nullable disable
#nullable restore
#line 10 "G:\ATuanLM\AuditProject\Audit\Program\Core\WebAppCoreBlazorNew\Pages\Search.razor"
using WebAppCoreBlazorNew.BUS;

#line default
#line hidden
#nullable disable
#nullable restore
#line 11 "G:\ATuanLM\AuditProject\Audit\Program\Core\WebAppCoreBlazorNew\Pages\Search.razor"
using WebCore.Entities;

#line default
#line hidden
#nullable disable
#nullable restore
#line 12 "G:\ATuanLM\AuditProject\Audit\Program\Core\WebAppCoreBlazorNew\Pages\Search.razor"
using Microsoft.Extensions.Caching.Distributed;

#line default
#line hidden
#nullable disable
    [Microsoft.AspNetCore.Components.RouteAttribute("/Search")]
    public partial class Search : Microsoft.AspNetCore.Components.ComponentBase
    {
        #pragma warning disable 1998
        protected override void BuildRenderTree(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder __builder)
        {
        }
        #pragma warning restore 1998
#nullable restore
#line 322 "G:\ATuanLM\AuditProject\Audit\Program\Core\WebAppCoreBlazorNew\Pages\Search.razor"
          
        //[Parameter]
        public string modId { get; set; } = "03200";
        //[Parameter]
        public string parramMods { get; set; } = "";
        public string Title { get; set; } = "";
        private string Schema { get; set; } = "core";
        public ModuleInfoModel moduleInfoModel { get; set; } = new ModuleInfoModel();
        public ModuleInfoModel ModuleInfo { get; set; } = new ModuleInfoModel();
        public List<ModuleFieldInfo> moduleFieldInfo { get; set; } = new List<ModuleFieldInfo>();
        public List<SelectListItem> lstControl { get; set; } = new List<SelectListItem>();
        public List<ModuleFieldInfo> fieldSubmited { get; set; } = new List<ModuleFieldInfo>();
        public List<GroupMod> groupMods { get; set; } = new List<GroupMod>();
        public List<ButtonInfo> btnInfos { get; set; } = new List<ButtonInfo>();
        public List<CodeInfoModel> codeInfos { get; set; } = new List<CodeInfoModel>();
        public List<ButtonInfo> checkBtnViews { get; set; } = new List<ButtonInfo>();
        public List<ButtonInfo> checkColAction { get; set; } = new List<ButtonInfo>();
        public List<ButtonInfo> checkBtnEdits { get; set; } = new List<ButtonInfo>();
        public List<ButtonInfo> checkBtnDels { get; set; } = new List<ButtonInfo>();
        public List<ButtonInfo> checkBtnAssRole { get; set; } = new List<ButtonInfo>();
        public List<ButtonInfo> checkBtnAssUsers { get; set; } = new List<ButtonInfo>();

        public List<GroupMod> RoleUser { get; set; } = new List<GroupMod>();

        public bool checkBtnDel { get; set; }
        public bool checkBtnView { get; set; }
        public bool checkBtnEdit { get; set; }
        public bool checkBtnAssignRole { get; set; }
        public bool checkBtnAssignUser { get; set; }


        public List<ButtonParamInfo> parramEdit { get; set; } = new List<ButtonParamInfo>();
        public List<ButtonParamInfo> parramView { get; set; } = new List<ButtonParamInfo>();
        public List<ButtonParamInfo> parramDel { get; set; } = new List<ButtonParamInfo>();
        public List<ButtonParamInfo> parramAssignUser { get; set; } = new List<ButtonParamInfo>();
        public List<CodeInfoModel> DataCombobox { get; set; } = new List<CodeInfoModel>();
        public int currPage { get; set; }
        public int totalRow { get; set; }
        public List<dynamic> DataSearch { get; set; } = new List<dynamic>();
        protected override async Task OnInitializedAsync()
        {
            try
            {
                //if (string.IsNullOrEmpty(HttpContext.Session.GetString("UserName")) && modId.ToLower() != ConstMod.ModListHomo.ToLower())
                //{
                //    return RedirectToAction("Login", "Home");
                //    NavigationManager.NavigateTo("PageToRedirect");
                //}
                lstControl = new List<SelectListItem>();
                moduleFieldInfo = new List<ModuleFieldInfo>();
                HomeBus homeBus = new HomeBus(moduleService, iConfiguration, distributedCache);
                var data = await homeBus.GetModule(modId);
                int userId = int.Parse("0" + ""/*HttpContext.Session.GetString("UserId")*/);
                var groupModUser = await moduleService.GetGroupModByUserId(userId);
                RoleUser = groupModUser;
                var module = homeBus.ConvertFromViewModel(data);
                Title = module.ModulesInfo.ModuleName.GetLanguageTitle(await homeBus.LoadAllBtnLanguage());
                ModuleInfo = module;
                var cb = module.FieldsInfo.Where(x => !String.IsNullOrEmpty(x.ListSource));
                var scdType = module.FieldsInfo.Select(x => x.ConditionType);
                if (cb.Any())
                {
                    var codeInfoParram = cb.Select(x => new CodeInfoParram
                    {
                        CtrlType = x.ControlType,
                        Name = x.FieldName,
                        ListSource = x.ListSource
                    });
                    //var para = string.Join("", sources);
                    var sourceCodeInfo = cb.Where(x => x.ListSource.Contains(":"));//Lấy những thông tin các ListSource từ DefCode
                    var codeInfoModels = new List<CodeInfoModel>();
                    if (sourceCodeInfo != null && sourceCodeInfo.Any())
                    {
                        var defCodeAll = await homeBus.LoadAllDefCode();
                        var lstSource = sourceCodeInfo.Select(x => x.ListSource).ToList();
                        var cbDefCode = defCodeAll.Where(x => lstSource.Contains(":" + x.CodeType + "." + x.CodeName));
                        foreach (var item in sourceCodeInfo)
                        {
                            codeInfoModels.Add(new CodeInfoModel { Name = item.FieldName, CodeInfos = cbDefCode.Where(x => ":" + x.CodeType + "." + x.CodeName == item.ListSource).ToList() });
                        }
                    }
                    var dataCB = (await moduleService.GetCombobox(codeInfoParram.Where(x => !x.ListSource.Contains(":")).ToList()));//Lấy thông tin các Combobox theo Store
                    codeInfoModels.AddRange(dataCB.Data);
                    DataCombobox = codeInfoModels;
                }

                var modSearch = await homeBus.LoadModSearchByModId(modId);
                if (modSearch != null)
                {
                    var parrams = new List<string>();
                    if (!string.IsNullOrEmpty(parramMods))
                    {
                        var btnParramInfo = (List<ButtonParamInfo>)JsonConvert.DeserializeObject<List<ButtonParamInfo>>(parramMods);
                        var temp = btnParramInfo.Select(x => x.FieldName + " = '" + x.Value + "'");
                        parrams.AddRange(temp);
                    }
                    var query = "";
                    if (modSearch.QueryFormat.IndexOf("{0}") > 0)
                    {
                        if (modSearch.QueryFormat.IndexOf("{1}") > 0)
                        {
                            var currPage = 1;
                            var paging = String.Format(" RowNumber Between {0} AND {1}", (currPage - 1) * CommonMethod.PageSize, (currPage - 1) * CommonMethod.PageSize + CommonMethod.PageSize);
                            query = string.Format(modSearch.QueryFormat, Schema, parrams.Any() ? String.Join(" AND ", parrams) : " 1=1 ", paging);
                            //ViewBag.CurrPage = currPage;
                        }
                        else
                        {
                            query = string.Format(modSearch.QueryFormat, Schema, parrams.Any() ? String.Join(" AND ", parrams) : " 1=1 ");
                        }
                    }
                    else
                    {
                        query = String.Format(modSearch.QueryFormat, Schema);
                    }
                    var dataGrid = await moduleService.LoadQueryModule(new ParramModuleQuery { Store = query });

                    //var dataGrid = await _moduleService.LoadQueryModule(new ParramModuleQuery { Store = modSearch.QueryFormat });
                    DataSearch = dataGrid;
                }

                //eturn View("Search", modId);
            }
            catch (Exception ex)
            {

                //return View("Search", modId);
            }
        }

    

#line default
#line hidden
#nullable disable
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IModuleService moduleService { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IDistributedCache distributedCache { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IConfiguration iConfiguration { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private NavigationManager NavigationManager { get; set; }
    }
}
#pragma warning restore 1591
